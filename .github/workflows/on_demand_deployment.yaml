name: Deploy Application Docker Image to EC2 

on:
  repository_dispatch:
    types: [event-on-demand-deployment]

permissions:
  id-token: write
  contents: read

env:
  OWNER: "ashish-soni-org"
  ACTION_TYPE: "CHECK_MAPPING"
  REPO_NAME: ${{ github.event.client_payload.repo }}
  ENDPOINT: ${{ github.event.client_payload.endpoint }}

jobs:
  deploy_to_ec2:
    name: Deploy & Configure Nginx
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION_NAME }}

      # 1. Login to ECR
      - name: Login to Amazon ECR
        id: login_ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: pip install ansible boto3 botocore

      # 2. Run Python Script (Get Proxy & Repo Name)
      - name: Determine Mapping & Port
        id: check_mapping
        run: python .github/workflows/secretsManager.py
        env:
          AWS_REGION: ${{ secrets.AWS_REGION_NAME }}
          SECRET_FILE_NAME: ${{ secrets.SECRETS_FILE_NAME }}
          ACTION_TYPE: ${{ env.ACTION_TYPE }}
          REPO_NAME: ${{ env.REPO_NAME }}

      # 3. Fetch ALL Running EC2 Instances (No Tag Filter)
      - name: Fetch Target Instances
        id: fetch_instances
        run: |
          # Query AWS for ANY instance in 'running' state
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].InstanceId" \
            --output text | tr '\t' ',')
          
          if [ -z "$INSTANCE_IDS" ]; then
            echo "Error: No running instances found in region ${{ secrets.AWS_REGION_NAME }}."
            exit 1
          fi
          
          # Append trailing comma for Ansible inventory syntax consistency
          echo "instance_ids=${INSTANCE_IDS}," >> $GITHUB_OUTPUT
          echo "Found Targets: $INSTANCE_IDS"

      - name: Create Vault Password File
        run: |
          echo "${{ secrets.VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      # 4. Run Ansible with Hidden Variables
      - name: Run Ansible Deployment Playbook
        working-directory: ansible/nginx/config
        # Map ALL sensitive values here. GitHub logs will show the variable names, not the values.
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
          # Inputs from Context
          REPO_NAME: ${{ env.REPO_NAME }}
          ENDPOINT: ${{ env.ENDPOINT }}
          # Inputs from Steps
          INSTANCE_IDS: ${{ steps.fetch_instances.outputs.instance_ids }}
          ECR_REGISTRY: ${{ steps.login_ecr.outputs.registry }}
          ECR_REPO_NAME: ${{ steps.check_mapping.outputs.ecr_repo_name }}
          PROXY_TARGET: ${{ steps.check_mapping.outputs.proxy_target }}
          IS_MAPPED: ${{ steps.check_mapping.outputs.is_mapped }}
        run: |
          # Construct URI using bash variables (The log will only show the variable names)
          FULL_URI="${ECR_REGISTRY}/${ECR_REPO_NAME}:latest"

          # Execute Ansible using bash variables
          ansible-playbook project_mapping.yaml \
            -i "${INSTANCE_IDS}" \
            --vault-password-file ../../../.vault_pass \
            -e "repo_name=${REPO_NAME}" \
            -e "image_uri=${FULL_URI}" \
            -e "proxy_target=${PROXY_TARGET}" \
            -e "is_mapped=${IS_MAPPED}" \
            -e "endpoint=${ENDPOINT}"

      - name: Cleanup
        if: always()
        run: rm -f .vault_pass