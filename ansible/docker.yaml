- name: Install Docker
  hosts: all
  become: true
  vars_files:
    - nginx/vars/secrets.yml

  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: ansible-ssm-artifacts-ashish-123
    ansible_aws_ssm_region: ap-south-1

  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:

    # - name: Install prerequisites packages
    #   ansible.builtin.apt:
    #     name:
    #       - ca-certificates
    #       - curl
    #       - gnupg
    #     state: present
    #     update_cache: true

    # - name: Ensure Keyrings path exists
    #   ansible.builtin.file:
    #     path: /etc/apt/keyrings
    #     state: directory
    #     mode: '0755'

    # - name: Add Docker official GPG key
    #   ansible.builtin.get_url:
    #     url: https://download.docker.com/linux/ubuntu/gpg
    #     dest: /etc/apt/keyrings/docker.asc
    #     mode: '0644'

    # - name: Convert Docker GPG key to binary keyring
    #   ansible.builtin.command:
    #     cmd: gpg --dearmor -o /etc/apt/keyrings/docker.gpg /etc/apt/keyrings/docker.asc
    #     creates: /etc/apt/keyrings/docker.gpg

    # - name: Ensure permissions on Docker GPG key
    #   ansible.builtin.file:
    #     path: /etc/apt/keyrings/docker.gpg
    #     mode: '0644'

    # - name: Add Docker APT repository
    #   ansible.builtin.apt_repository:
    #     repo: >
    #       deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
    #       https://download.docker.com/linux/ubuntu
    #       {{ ansible_distribution_release }} stable
    #     state: present
    #     filename: docker

    # - name: Install Docker Engine packages
    #   ansible.builtin.apt:
    #     name:
    #       - docker-ce
    #       - docker-ce-cli
    #       - containerd.io
    #     state: present
    #     update_cache: true

    # - name: Create working directory
    #   ansible.builtin.file:
    #     path: /home/ubuntu/docker_startup_creation_scripts
    #     state: directory
    #     mode: '0755'

    # - name: Upload docker script file to server
    #   ansible.builtin.copy:
    #     src: "{{ item }}"
    #     dest: /home/ubuntu/docker_startup_creation_scripts
    #     mode: '0755'
    #   loop:
    #     - docker/startup_script.sh

    # - name: Upload docker service file to server
    #   ansible.builtin.copy:
    #     src: "{{ item }}"
    #     dest: /etc/systemd/system
    #     mode: '0755'
    #   loop:
    #     - docker/startup.service
    - name: Install AWS CLI
      ansible.builtin.apt:
        name: awscli
        state: present
        update_cache: true
    
    - name: Configre Docker for Repositories
      ansible.builtin.shell: 
        cmd: "./startup_script.sh '{{ FILE_PATH }}' '{{ LOG_FILE_NAME }}' '{{ STARTUP_FILE_NAME }}' '{{ REGION }}' '{{ USERNAME }}' '{{ ECR }}' '{{ CONTAINERS }}' '{{ MAPPED_PORTS }}'"
      args:
        chdir: /home/ubuntu/docker_startup_creation_scripts

    - name: Ensure Docker service is running and enabled
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    - name: Ensure docker group exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add user to group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true
