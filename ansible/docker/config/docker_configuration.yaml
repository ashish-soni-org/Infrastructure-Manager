- name: Creating Docker Startup Service
  hosts: all
  become: true

  vars_files:
    - ../../secrets/secrets.yml

  vars:
    ansible_connection: "{{ ANSIBLE_CONNECTION }}"
    ansible_aws_ssm_bucket_name: "{{ ANSIBLE_AWS_SSM_BUCKET_NAME }}"
    ansible_aws_ssm_region: "{{ ANSIBLE_AWS_SSM_REGION }}"

    # -----------------------------------------------------------
    # 1. PERMISSION & CONNECTION FIXES
    # -----------------------------------------------------------
    # Explicitly define the user to run scripts as
    ansible_user: ubuntu
    
    # Force use of /tmp for temporary files (Essential for AWS SSM connections)
    ansible_remote_tmp: /tmp/.ansible-${USER}/tmp

    # -----------------------------------------------------------
    # 2. SCRIPT CONFIGURATION VARIABLES (Restored)
    # -----------------------------------------------------------
    WORKDIR: /home/ubuntu/docker_startup_creation_scripts
    LOG_FILE_NAME: startup.log
    STARTUP_FILE_NAME: startup.sh
    USERNAME: AWS
    # NOTE: You must pass 'ECR', 'CONTAINERS', and 'MAPPED_PORTS' via -e in GitHub Actions
    # OR define defaults here if they are static.
    
  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:
        timeout: 300

    - name: Create working directory
      ansible.builtin.file:
        path: "{{ WORKDIR }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Upload docker script file to server
      ansible.builtin.copy:
        src: startup_script.sh
        dest: "{{ WORKDIR }}/startup_script.sh"
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Upload docker service file to server
      ansible.builtin.copy:
        src: startup.service
        dest: /etc/systemd/system/startup.service
        mode: '0644'

    # --- AWS CLI Installation ---
    - name: Install unzip
      ansible.builtin.apt:
        name: unzip
        state: present
        update_cache: true

    - name: Download AWS CLI installer
      ansible.builtin.get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip
        mode: '0644'

    - name: Extract AWS CLI installer
      ansible.builtin.unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp/
        remote_src: true

    - name: Run AWS CLI installer
      ansible.builtin.shell:
        cmd: ./aws/install --update
        chdir: /tmp/
      register: aws_install_result
      changed_when: "'You can now run: /usr/local/bin/aws' in aws_install_result.stdout"
    
    # --- Generate Startup Script ---
    - name: Configure Docker for Repositories
      ansible.builtin.shell: 
        # FIX: Explicitly use /bin/bash
        cmd: >
          /bin/bash ./startup_script.sh 
          "{{ WORKDIR }}" 
          "{{ LOG_FILE_NAME }}" 
          "{{ STARTUP_FILE_NAME }}" 
          "{{ REGION }}" 
          "{{ USERNAME }}" 
          "{{ ECR }}" 
          "{{ CONTAINERS }}" 
          "{{ MAPPED_PORTS }}"
      args:
        chdir: "{{ WORKDIR }}"
      # Run as root (default become: true) to avoid directory permission issues.
      # The 'become_user' line was removed because root access is safer for this operation.

    - name: Enable and start startup service
      ansible.builtin.systemd:
        name: startup.service
        enabled: true
        daemon_reload: true
        state: restarted