- name: Configure Nginx
  hosts: all
  gather_facts: false
  become: true

  vars_files:
    - ../../secrets/secrets.yml

  vars:
    ansible_connection: "{{ ANSIBLE_CONNECTION }}"
    ansible_aws_ssm_bucket_name: "{{ ANSIBLE_AWS_SSM_BUCKET_NAME }}"
    ansible_aws_ssm_region: "{{ ANSIBLE_AWS_SSM_REGION }}"
    WORKDIR: /home/ubuntu/nginx_config_creation_scripts
    
    # Safe parsing: If "false", return empty list, otherwise parse the JSON string
    domain_list: "{{ (dns_instances != 'false') | ternary(dns_instances | from_json, []) }}"

  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:
        timeout: 300

    - name: Create working directory
      ansible.builtin.file:
        path: "{{ WORKDIR }}"
        state: directory
        mode: '0755'

    - name: Upload nginx scripts to server
      ansible.builtin.copy:
        src: basic_config.sh
        dest: "{{ WORKDIR }}/basic_config.sh"
        mode: '0755'

    # ------------------------------------------------------------
    # SCENARIO 1: Domains Provided (dns_instances is NOT "false")
    # ------------------------------------------------------------

    - name: Create domain specific configuration files
      ansible.builtin.shell: 
        cmd: "./basic_config.sh '{{ item.domain }}' '{{ CONFIG_FOLDER }}'"
      args:
        chdir: "{{ WORKDIR }}"
      loop: "{{ domain_list }}"
      loop_control:
        label: "{{ item.domain }}"
      when: dns_instances != "false"

    - name: Enable domain sites (Symlink)
      ansible.builtin.file:
        src: "{{ CONFIG_FOLDER }}/{{ item.domain }}"
        dest: "{{ ENABLEMENT_FOLDER }}/{{ item.domain }}"
        state: link
        force: true
      loop: "{{ domain_list }}"
      loop_control:
        label: "{{ item.domain }}"
      when: dns_instances != "false"

    - name: Remove default NGINX config (Cleanup)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ ENABLEMENT_FOLDER }}/default"
        - "{{ CONFIG_FOLDER }}/default"
      when: dns_instances != "false"

    # ------------------------------------------------------------
    # SCENARIO 2: No Domain Provided (dns_instances IS "false")
    # ------------------------------------------------------------

    - name: Update default configuration file
      ansible.builtin.shell: 
        cmd: "./basic_config.sh 'default' '{{ CONFIG_FOLDER }}'"
      args:
        chdir: "{{ WORKDIR }}"
      when: dns_instances == "false"

    - name: Ensure default site is enabled
      ansible.builtin.file:
        src: "{{ CONFIG_FOLDER }}/default"
        dest: "{{ ENABLEMENT_FOLDER }}/default"
        state: link
        force: true
      when: dns_instances == "false"

    # ------------------------------------------------------------
    # RELOAD SERVICE
    # ------------------------------------------------------------

    - name: Reload Nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded