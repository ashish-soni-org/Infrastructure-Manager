- name: Configure Nginx
  hosts: all
  gather_facts: false
  become: true

  vars_files:
    - ../../secrets/secrets.yml

  vars:
    ansible_connection: "{{ ANSIBLE_CONNECTION }}"
    ansible_aws_ssm_bucket_name: "{{ ANSIBLE_AWS_SSM_BUCKET_NAME }}"
    ansible_aws_ssm_region: "{{ ANSIBLE_AWS_SSM_REGION }}"
    WORKDIR: /home/ubuntu/nginx_config_creation_scripts

  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:
        timeout: 300

    - name: Create working directory
      ansible.builtin.file:
        path: "{{ WORKDIR }}"
        state: directory
        mode: '0755'

    - name: Upload nginx scripts to server
      ansible.builtin.copy:
        src: basic_config.sh
        dest: "{{ WORKDIR }}/basic_config.sh"
        mode: '0755'
    
    - name: Create basic configuration file
      ansible.builtin.shell: 
        cmd: "./basic_config.sh '{{ item.domain }}' '{{ CONFIG_FOLDER }}'"
      args:
        chdir: "{{ WORKDIR }}"
      loop: "{{ dns_instances | from_json }}"
      loop_control:
        label: "{{ item.instance_id }} â†’ {{ item.domain }}"

    - name: Enable the site
      ansible.builtin.file:
        src: "{{ CONFIG_FOLDER }}/{{ item.domain }}"
        dest: "{{ ENABLEMENT_FOLDER }}/{{ item.domain }}"
        state: link
        force: true
      loop: "{{ dns_instances | from_json }}"
      loop_control:
        label: "{{ item.domain }}"

    - name: Remove default NGINX config from sites-enabled
      ansible.builtin.file:
        path: "{{ ENABLEMENT_FOLDER }}/default"
        state: absent

    - name: Remove default NGINX config from sites-available
      ansible.builtin.file:
        path: "{{ CONFIG_FOLDER }}/default"
        state: absent

    - name: Reload Nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded