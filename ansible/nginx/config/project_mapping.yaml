- name: Deploy Docker Service and Configure Nginx
  hosts: all
  gather_facts: false
  become: true

  vars_files:
    - ../../secrets/secrets.yml

  vars:
    ansible_connection: "{{ ANSIBLE_CONNECTION }}"
    ansible_aws_ssm_bucket_name: "{{ ANSIBLE_AWS_SSM_BUCKET_NAME }}"
    ansible_aws_ssm_region: "{{ ANSIBLE_AWS_SSM_REGION }}"
    WORKDIR: /home/ubuntu/nginx_config_creation_scripts
    NGINX_ENABLED: /etc/nginx/sites-enabled

  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:
        timeout: 300

    # 0. CLEANUP LEGACY
    - name: Disable and stop legacy startup service
      ansible.builtin.systemd:
        name: startup.service
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Remove legacy startup service file
      ansible.builtin.file:
        path: /etc/systemd/system/startup.service
        state: absent

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    # 1. AWS CLI PREREQUISITES
    - name: Install Unzip
      ansible.builtin.package:
        name: unzip
        state: present

    - name: Check if AWS CLI is installed
      ansible.builtin.command: aws --version
      register: aws_cli_check
      ignore_errors: true
      changed_when: false

    - name: Download AWS CLI
      ansible.builtin.get_url:
        url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        dest: "/tmp/awscliv2.zip"
      when: aws_cli_check.rc != 0

    - name: Unzip AWS CLI
      ansible.builtin.unarchive:
        src: "/tmp/awscliv2.zip"
        dest: "/tmp"
        remote_src: yes
      when: aws_cli_check.rc != 0

    - name: Install AWS CLI
      ansible.builtin.command: "/tmp/aws/install --update"
      when: aws_cli_check.rc != 0

    # 2. IDENTIFY NGINX CONFIG FILE
    - name: Check for default config
      ansible.builtin.stat:
        path: "{{ NGINX_ENABLED }}/default"
      register: default_conf

    - name: Find other config files
      ansible.builtin.find:
        paths: "{{ NGINX_ENABLED }}"
        file_type: any
        recurse: no
        patterns: "*"
        excludes: "default"
      register: other_confs
      when: not default_conf.stat.exists

    - name: Set Active Config File Fact
      ansible.builtin.set_fact:
        active_config_file: >-
          {{
            (NGINX_ENABLED ~ '/default')
            if default_conf.stat.exists
            else (other_confs.files | map(attribute='path') | list | first | default(''))
          }}

    - name: Fail if no Nginx config found
      ansible.builtin.fail:
        msg: "No active Nginx configuration file found in {{ NGINX_ENABLED }}"
      when: active_config_file == ""

    # 3. DOCKER LIFECYCLE
    - name: Log into ECR
      ansible.builtin.shell: |
        aws ecr get-login-password --region {{ ansible_aws_ssm_region }} | docker login --username AWS --password-stdin {{ image_uri.split('/')[0] }}
      no_log: true
      when: image_uri is defined and image_uri | length > 0

    - name: Stop and Remove Existing Container
      community.docker.docker_container:
        name: "{{ repo_name }}"
        state: absent
        force_kill: true
      
    - name: Pull New Docker Image
      community.docker.docker_image:
        name: "{{ image_uri }}"
        source: pull
        force_source: true
      when: image_uri is defined and image_uri | length > 0

    - name: Run New Docker Container
      community.docker.docker_container:
        name: "{{ repo_name }}"
        image: "{{ image_uri }}"
        state: started
        restart_policy: always
        ports:
          - "{{ proxy_target | regex_search(':[0-9]+') | replace(':','') }}:80"
      when: image_uri is defined and image_uri | length > 0

    # 4. NGINX MAPPING
    - name: Upload Mapping Script
      ansible.builtin.copy:
        src: project_config.sh
        dest: "{{ WORKDIR }}/project_config.sh"
        mode: '0755'
      when: not is_mapped | bool

    - name: Inject Nginx Mapping
      ansible.builtin.shell: |
        ./project_config.sh "{{ active_config_file }}" "{{ endpoint }}" "{{ proxy_target }}"
      args:
        chdir: "{{ WORKDIR }}"
      when: not is_mapped | bool

    - name: Check Nginx Syntax
      ansible.builtin.command: nginx -t
      when: not is_mapped | bool

    - name: Reload Nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
      when: not is_mapped | bool