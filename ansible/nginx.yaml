- name: Install and start Nginx on Ubuntu
  hosts: all
  gather_facts: false
  become: true
  vars_files:
    - vars/secrets.yml

  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: ansible-ssm-artifacts-ashish-123
    ansible_aws_ssm_region: ap-south-1

  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:

    # - name: Install nginx
    #   ansible.builtin.apt:
    #     name: nginx
    #     state: present
    #     update_cache: true

    # - name: Starting Nginx service
    #   ansible.builtin.service:
    #     name: nginx
    #     state: started
    #     enabled: true

    - name: Configre Nginx for Repositories
      ansible.builtin.shell: 
        # We use 'from_yaml' to fix the string format issue automatically
        cmd: "./main.sh '{{ Test_Variable_Value }}' {{ (Test_Array_Value | from_yaml) | map('quote') | join(' ') }}"
      args:
        chdir: /home/ubuntu/
      # Only run this if we actually have the list
      when: Test_Array_Value is defined

    # - name: Upload test script to server
    #   ansible.builtin.copy:
    #     src: "{{ item }}"
    #     dest: /home/ubuntu/
    #     mode: '0755'
    #   loop:
    #     - ./main.sh
    #     - ./basic_config.sh
    #     - ./project_config.sh
    
    # - name: Configre Nginx for Repositories
    #   ansible.builtin.shell: 
    #     cmd: "./main.sh '{{ Test_Variable_Value }}' {{ Test_Array_Value | map('quote') | join(' ') }}"
    #   args:
    #     chdir: /home/ubuntu/