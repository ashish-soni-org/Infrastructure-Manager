# Wait for SSM Agent to be available on the Instance
- name: Wait for connection to be available
  hosts: all
  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: ansible-ssm-artifacts-ashish-123
    ansible_aws_ssm_region: ap-south-1
    # When the S3 bucket isn't in the same region as the Instance
    # Explicitly setting the addressing style to 'virtual' may be necessary
    # https://repost.aws/knowledge-center/s3-http-307-response
  tasks:
    - name: Wait for connection
      wait_for_connection:

- name: Install and start runner on ubuntu
  hosts: all
  gather_facts: false
  become: true

  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: ansible-ssm-artifacts-ashish-123
    ansible_aws_ssm_region: ap-south-1

  tasks:
    - name: Test connectivity before download
      ansible.builtin.shell: curl -I https://github.com/
      register: curl_check
    - name: Print curl check result
      ansible.builtin.debug:
        var: curl_check.stdout_lines

    # Add these to your initial setup tasks if they aren't already there
    - name: Install dependencies for runner
      ansible.builtin.apt:
        name: ['curl', 'jq', 'git']
        state: present
      when: ansible_os_family == "Debian"

    - name: Create runner directory
      ansible.builtin.file:
        path: /home/ubuntu/actions-runner
        state: directory
        owner: "ubuntu"
        mode: '0755'

    - name: Download the latest runner package
      ansible.builtin.get_url:
        url: https://github.com/actions/runner/releases/download/v2.316.0/actions-runner-linux-x64-2.316.0.tar.gz # Check for the latest version!
        dest: /home/ubuntu/actions-runner/actions-runner-linux-x64.tar.gz
        owner: "ubuntu"

    - name: Extract the runner package
      ansible.builtin.unarchive:
        src: /home/ubuntu/actions-runner/actions-runner-linux-x64.tar.gz
        dest: /home/ubuntu/actions-runner
        owner: "ubuntu"
        remote_src: yes

    - name: Get GitHub Runner Registration Token
      ansible.builtin.uri:
        url: "{{ REPO_URL | replace('https://github.com/', 'https://api.github.com/repos/') }}/actions/runners/registration-token"
        method: POST
        headers:
          Authorization: "token {{ GITHUB_TOKEN }}"
          Accept: "application/vnd.github.v3+json"
        status_code: 201
        return_content: yes
      register: github_token_response

    - name: Extract registration token
      ansible.builtin.set_fact:
        runner_token: "{{ github_token_response.json.token }}"

    - name: Configure the runner
      ansible.builtin.command: |
        ./config.sh \
          --url {{ REPO_URL }} \
          --token {{ runner_token }} \
          --name {{ inventory_hostname }} \
          --labels linux,x64,aws,ec2
      args:
        chdir: /home/ubuntu/actions-runner
        # This prevents the command from blocking, as config.sh can ask questions
        # But note: it does not background the runner, it only performs the config
        # You may need to pipe 'echo "no"' to it if you want to run it completely non-interactively.
        # The default flags usually make it non-interactive enough for automation.

    - name: Install and start the runner service
      become: yes # Requires root/sudo
      ansible.builtin.command: |
        ./svc.sh install
      args:
        chdir: /home/ubuntu/actions-runner

    - name: Enable and start runner service
      become: yes # Requires root/sudo
      ansible.builtin.systemd:
        name: actions.runner.{{ inventory_hostname }}.service
        enabled: yes
        state: started